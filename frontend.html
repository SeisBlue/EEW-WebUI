<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Waveform WebSocket + deck.gl demo</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; }
    #controls { padding: 8px; background: #f0f0f0; }
    #vis { width: 100vw; height: 90vh; }
    canvas { width: 100%; height: 100%; }
    pre { margin: 0; font-size: 12px; }
  </style>
  <!-- load deck.gl -->
  <script src="https://unpkg.com/deck.gl@8.8.0/dist.min.js"></script>
  <script src="https://unpkg.com/@deck.gl/layers@8.8.0/dist.min.js"></script>
</head>
<body>
  <div id="controls">
    <label>Station: <input id="station" value="STA0001"></label>
    <button id="subscribe">Subscribe</button>
    <button id="fetch">Fetch 30s</button>
    <span id="status">disconnected</span>
  </div>
  <div id="vis"></div>
  <script>
    const ws = new WebSocket("ws://localhost:8000/ws");
    ws.binaryType = "arraybuffer";
    const stationInput = document.getElementById('station');
    const subscribeBtn = document.getElementById('subscribe');
    const fetchBtn = document.getElementById('fetch');
    const status = document.getElementById('status');

    // deck.gl simple canvas: we will draw waveform as a line using PathLayer.
    const deckgl = new deck.DeckGL({
      container: 'vis',
      initialViewState: {
        longitude: 0,
        latitude: 0,
        zoom: 0,
        bearing: 0,
        pitch: 0
      },
      controller: true,
      layers: []
    });

    let currentSamples = null;

    function renderWaveform(samples) {
      // normalize samples and create a simple path (x,y) coordinates
      const n = samples.length;
      const arr = Array.from(samples);
      const maxv = Math.max(...arr.map(Math.abs)) || 1;
      const points = arr.map((v, i) => {
        const x = i / n * 360 - 180;   // map to x coordinate (dummy lon)
        const y = (v / maxv) * 10;     // map amplitude to lat
        return [x, y];
      });

      const pathLayer = new deck.PathLayer({
        id: 'wave-path',
        data: [{path: points}],
        getPath: d => d.path,
        getWidth: 2,
        getColor: [255, 0, 0],
        rounded: true,
        widthMinPixels: 1
      });
      deckgl.setProps({layers: [pathLayer]});
    }

    ws.onopen = () => {
      status.textContent = 'connected';
    };
    ws.onclose = () => status.textContent = 'closed';
    ws.onerror = (e) => console.error(e);

    ws.onmessage = (ev) => {
      if (typeof ev.data === 'string') {
        try {
          const j = JSON.parse(ev.data);
          console.log('meta', j);
        } catch (e) {
          console.log('text', ev.data);
        }
      } else if (ev.data instanceof ArrayBuffer) {
        const buf = new Int16Array(ev.data);
        // draw with deck.gl
        renderWaveform(buf);
      }
    };

    subscribeBtn.onclick = () => {
      const station = stationInput.value.trim();
      ws.send(JSON.stringify({action: 'subscribe', station}));
    };
    fetchBtn.onclick = () => {
      const station = stationInput.value.trim();
      ws.send(JSON.stringify({action: 'fetch_window', station}));
    };
  </script>
</body>
</html>