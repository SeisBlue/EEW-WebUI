services:
  earthworm:
    image: cwadayi/earthworm_ubuntu22.04_eew:v1
    container_name: earthworm
    ipc: shareable
    command: bash -c "source /opt/earthworm/ew_linux.bash && startstop"
    stdin_open: true
    tty: true
  redis:
    image: redis:7-alpine
    container_name: redis
    command: redis-server --save "" --appendonly no
    ports:
      - "6379:6379"
  reader:
    image: seisblue/eew
    container_name: reader
    volumes:
      - ./:/workspace
    ipc: container:earthworm
    environment:
      - REDIS_HOST=redis
    command: bash -c "sleep 5 && /usr/local/bin/python /workspace/reader_pyew_to_redis.py -e test"
    restart: on-failure
    depends_on:
      - earthworm
      - redis
  backend:
    image: seisblue/eew
    container_name: backend
    volumes:
      - ./:/workspace
    environment:
      - REDIS_HOST=redis
    ports:
      - "5001:5001"
    command: ["/usr/local/bin/python", "/workspace/redis_fastapi_backend.py"]
    depends_on:
      - redis
  frontend:
    image: seisblue/eew
    container_name: frontend
    volumes:
      - ./:/workspace
    environment:
      - BACKEND_HOST=backend
    ports:
      - "3000:3000"
    working_dir: /workspace/frontend
    command: ["/usr/bin/pnpm", "run", "dev", "--host"]
